<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lectura</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #a9def9; }
        .sidebar {
            height: 100vh; width: 250px; position: fixed; left: 0; top: 0;
            background: #013a63; color: white; padding-top: 20px;
        }
        .sidebar a { color: white; text-decoration: none; padding: 10px; display: block; }
        .sidebar a:hover { background-color: #a9def9; }
        .main-content { margin-left: 250px; padding: 20px; }
        .user-icon { font-size: 50px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="text-center">
            <span class="user-icon">ğŸ‘¨â€ğŸ“</span>
            <h4>{{ request.session.nombre_usuario }}</h4>
        </div>
        <hr>
        <a href="{% url 'dashboard_usuario' %}">ğŸ  Inicio</a>
        <a href="{% url 'seleccion_tipo_texto' %}">ğŸ“– Iniciar evaluaciÃ³n</a>
        <a href="{% url 'resultados_usuario' %}">ğŸ“Š Mis resultados de evaluaciÃ³n</a>
        <a href="{% url 'logout_usuario' %}">ğŸšª Cerrar sesiÃ³n</a>
    </div>

    <div class="main-content">

        {% if es_pendiente %}
        <div class="alert alert-info text-center" role="alert">
          âœï¸ Â¡Hola de nuevo! EstÃ¡s retomando una lectura pendiente. Completa esta actividad para continuar.
        </div>
        {% endif %}

        <h2 class="mb-3">Disfruta de la lectura</h2>
        <p>Cuando termines, presiona "Siguiente".</p>

        <!-- NUEVO: Controles del cronÃ³metro (colÃ³calo aquÃ­, justo arriba del iframe) -->
        <div class="d-flex align-items-center gap-2 mb-3">
          <span>Tiempo: <strong id="cronometro">0.00</strong> s</span>
          <button id="btnPause" type="button" class="btn btn-warning btn-sm">Pausar</button>
          <button id="btnResume" type="button" class="btn btn-success btn-sm" disabled>Reanudar</button>
        </div>

        <iframe src="{{ ruta_texto|urlencode }}?t={{ timestamp }}" width="100%" height="600px"></iframe>
        <div class="text-end mt-4">
            <a id="siguiente-link" href="{% url 'mostrar_fragmento' %}?titulo={{ titulo }}&tipo={{ tipo_texto }}" class="btn btn-success" style="background-color: #006d77;">Siguiente</a>
        </div>
    </div>

    <!-- REEMPLAZA tu script anterior por este -->
    <script>
    // Lee CSRF desde la cookie (Django la envÃ­a por defecto si tienes CSRF middleware)
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    (function(){
      // Variables provenientes del servidor
      const titulo = "{{ titulo|escapejs }}";
      const tipo = "{{ tipo_texto|escapejs }}";
      const initialElapsed = parseFloat("{{ initial_elapsed|default:'0' }}") || 0;

      // DOM
      const elCrono = document.getElementById('cronometro');
      const btnPause = document.getElementById('btnPause');
      const btnResume = document.getElementById('btnResume');
      const siguienteLink = document.getElementById('siguiente-link');

      // Estado del cronÃ³metro
      let elapsedBefore = initialElapsed; // segundos acumulados guardados en servidor
      let startMs = Date.now();
      let paused = false;
      let rafId = null;

      const csrftoken = getCookie('csrftoken') || (document.querySelector('[name=csrfmiddlewaretoken]')||{}).value || '';

      function fmt(x){ return (Math.round(x*100)/100).toFixed(2); }

      function tick(){
        if (paused) return;
        const now = Date.now();
        const totalSec = elapsedBefore + (now - startMs)/1000;
        if (elCrono) elCrono.textContent = fmt(totalSec);
        rafId = requestAnimationFrame(tick);
      }

      function startLoop(){
        cancelAnimationFrame(rafId);
        startMs = Date.now();
        paused = false;
        if (btnPause) btnPause.disabled = false;
        if (btnResume) btnResume.disabled = true;
        tick();
      }

      async function post(url, data){
        const res = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrftoken
          },
          body: new URLSearchParams(data)
        });
        try { return await res.json(); } catch(e) { return {}; }
      }

      if (btnPause) {
        btnPause.addEventListener('click', async ()=>{
          if (paused) return;
          paused = true;
          cancelAnimationFrame(rafId);
          try{
            const resp = await post("{% url 'pausar_lectura' %}", {titulo, tipo});
            if (resp && resp.ok && typeof resp.segundos_acumulados === 'number') {
              elapsedBefore = resp.segundos_acumulados; // sincroniza con servidor
              if (elCrono) elCrono.textContent = fmt(elapsedBefore);
            }
          }catch(e){}
          if (btnPause) btnPause.disabled = true;
          if (btnResume) btnResume.disabled = false;
        });
      }

      if (btnResume) {
        btnResume.addEventListener('click', async ()=>{
          if (!paused) return;
          try{
            await post("{% url 'reanudar_lectura' %}", {titulo, tipo});
          }catch(e){}
          startLoop();
        });
      }

      // Al hacer clic en "Siguiente", aÃ±ade el tiempo total a la URL
      if (siguienteLink) {
        siguienteLink.addEventListener('click', ()=>{
          const now = Date.now();
          const total = paused ? elapsedBefore : (elapsedBefore + (now - startMs)/1000);
          const originalUrl = siguienteLink.getAttribute('href') || siguienteLink.href;
          const sep = originalUrl.includes('?') ? '&' : '?';
          siguienteLink.href = originalUrl + sep + 'tiempo_lectura_segundos=' + encodeURIComponent(fmt(total));
        });
      }

      // Inicia el cronÃ³metro
      startLoop();
    })();
    </script>

</body>
</html>
